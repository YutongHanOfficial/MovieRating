<!doctype html>
<html lang="en">
   <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width,initial-scale=1" />
      <title>Movie Ratings</title>
      <link rel="icon" type="image/png" href="/images/Favicon.png">
      <meta name="description" content="Movie Ratings is redefining how the world experiences film. Discover, rate, and discuss movies with a global community of fans â€” all on one powerful, immersive platform." />
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
      <style>
         :root{
         --bg: #0b1220; --card:#0f1724; --muted:#9aa7b2; --accent:#06b6d4; --accent-2:#8b5cf6;
         --glass: rgba(255,255,255,0.03); --radius:14px;
         --success: #00c48c; --danger:#ff6b6b;
         color-scheme: dark;
         }
         *{box-sizing:border-box}
         html,body {
         height: 100%;
         margin: 0;
         font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
         color: #e6eef6;
         background: radial-gradient(1200px 600px at 10% 10%, rgba(8,20,34,0.6), transparent),
         #06121a; /* solid dark base, no vertical gradient */
         }
         radial-gradient(1200px 600px at 10% 10%, rgba(8,20,34,0.6), transparent),
         linear-gradient(180deg,#071026 0%, #06121a 60%);}
         .wrap{max-width:1100px;margin:28px auto;padding:20px;display:grid;grid-template-columns:1fr 360px;gap:20px}
         header{grid-column:1 / -1;display:flex;align-items:center;justify-content:space-between;padding-bottom:8px}
         .brand{display:flex;gap:12px;align-items:center}
         .logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;font-weight:800;color:#012;box-shadow:0 6px 18px rgba(3,6,23,0.6)}
         h1{margin:0;font-size:18px}
         .top-actions{display:flex;gap:8px;align-items:center}
         button{cursor:pointer;border-radius:10px;border:none;padding:8px 12px;background:var(--accent);color:#042027;font-weight:700}
         button.ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04)}
         .card{background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.02));border-radius:var(--radius);padding:16px;box-shadow:0 8px 24px rgba(2,6,23,0.65);border:1px solid rgba(255,255,255,0.03)}
         .expanded-panel {
         background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
         border: 1px solid rgba(255,255,255,0.05);
         border-radius: var(--radius);
         padding: 18px 20px;
         margin-top: 10px;
         box-shadow: 0 4px 20px rgba(0,0,0,0.4);
         }
         .expanded-panel > * + * {
         margin-top: 14px;
         }
         .expanded-stats {
         display: flex;
         flex-direction: column;
         gap: 10px;
         padding: 10px 0;
         border-top: 1px solid rgba(255,255,255,0.05);
         border-bottom: 1px solid rgba(255,255,255,0.05);
         }
         .expanded-stats .summary {
         display: flex;
         align-items: center;
         gap: 12px;
         flex-wrap: wrap;
         }
         .expanded-stats .expanded-breakdown {
         display: flex;
         flex-wrap: wrap;
         gap: 6px;
         }
         .expanded-form {
         display: flex;
         flex-direction: column;
         gap: 10px;
         background: rgba(255,255,255,0.02);
         border-radius: 10px;
         padding: 12px;
         border: 1px solid rgba(255,255,255,0.04);
         }
         .expanded-form .stars-container {
         display: flex;
         flex-wrap: wrap;
         gap: 6px;
         }
         .expanded-form textarea {
         margin-top: 6px;
         }
         .expanded-list {
         display: flex;
         flex-direction: column;
         gap: 8px;
         padding-top: 10px;
         }
         .expanded-list .rating-item {
         background: rgba(255,255,255,0.02);
         border-radius: 8px;
         padding: 10px;
         display: flex;
         gap: 10px;
         align-items: flex-start;
         }
         .expanded-list .rating-item .avatar {
         flex-shrink: 0;
         width: 40px;
         height: 40px;
         border-radius: 8px;
         background: linear-gradient(135deg,#111827,#0b1220);
         display: grid;
         place-items: center;
         font-weight: 700;
         color: var(--muted);
         }
         .left{min-height:60vh}
         .controls{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
         /* ===== Enhanced Movie Search & Add Layout ===== */
         .movie-search-bar {
         width: 100%;
         display: flex;
         flex-direction: column;
         margin-bottom: 14px;
         }
         .search-label {
         font-weight: 700;
         font-size: 14px;
         color: var(--accent);
         margin-bottom: 6px;
         letter-spacing: 0.3px;
         text-transform: uppercase;
         }
         .movie-search-bar input[type="search"] {
         width: 100%;
         font-size: 15px;
         padding: 12px;
         border-radius: 12px;
         background: rgba(255,255,255,0.04);
         border: 1px solid rgba(255,255,255,0.1);
         }
         .movie-add-row {
         width: 100%;
         display: grid;
         grid-template-columns: 1fr 120px 1fr auto;
         gap: 10px;
         }
         .movie-add-row input[type="text"] {
         padding: 10px;
         border-radius: 10px;
         }
         .movie-add-row button {
         background: var(--accent);
         color: #041820;
         border: none;
         border-radius: 10px;
         font-weight: 700;
         cursor: pointer;
         transition: background 0.2s ease;
         }
         .movie-add-row button:hover {
         background: var(--accent-2);
         }
         input[type="text"], input[type="search"], select, textarea{background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:inherit;padding:10px;border-radius:10px;outline:none}
         textarea{min-height:84px;resize:vertical}
         .movie-list{display:grid;gap:12px;margin-top:10px}
         .movie-row{display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);cursor:pointer}
         .poster{width:72px;height:104px;border-radius:8px;background:linear-gradient(180deg,#071026,#0b1220);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--muted);font-size:20px}
         .poster-img {
         width: 72px;
         height: 104px;
         object-fit: cover;
         border-radius: 8px;
         flex-shrink: 0;
         box-shadow: 0 2px 8px rgba(0,0,0,0.5);
         }
         .meta{flex:1;display:flex;flex-direction:column}
         .title-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
         .movie-title{font-size:16px;margin:0}
         .small{font-size:13px;color:var(--muted)}
         .rating-block{display:flex;gap:8px;align-items:center}
         .avg{font-weight:800;font-size:18px}
         .stars{display:flex;gap:6px;align-items:center}
         .star{width:26px;height:26px;display:inline-grid;place-items:center;border-radius:6px;cursor:pointer;user-select:none}
         .star.on{background:linear-gradient(180deg,var(--accent),#07a3b5);color:#012}
         .right{min-width:320px}
         .top-raters .rater{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px}
         .avatar{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#111827,#0b1220);display:inline-grid;place-items:center;font-weight:800;color:var(--muted)}
         footer {
         grid-column: 1 / -1;
         text-align: center;
         margin-top: 12px;
         color: var(--muted);
         font-size: 13px;
         background: linear-gradient(180deg, #0b1220 0%, #151b34 100%);
         padding: 20px 0;
         }
         .badge{background:rgba(255,255,255,0.06);padding:4px 8px;border-radius:999px;font-weight:700;font-size:12px;color:#d9f7ff}
         @media (max-width:980px){.wrap{grid-template-columns:1fr;padding:12px}.right{order:3}}
      </style>
   </head>
   <body>
      <div class="wrap" id="app">
         <header>
            <div class="brand">
               <div class="logo">MR</div>
               <div>
                  <h1>Movie Ratings</h1>
                  <div class="small">Verified Movie Ratings</div>
               </div>
            </div>
            <div class="top-actions">
               <div id="signedOutControls">
                  <button id="signInBtn">Sign in with Google</button>
               </div>
               <div id="signedInControls" style="display:none;align-items:center;gap:8px">
                  <div class="small" id="userName">â€”</div>
                  <div id="verifiedBadge"></div>
                  <button id="signOutBtn" class="ghost">Sign out</button>
               </div>
            </div>
         </header>
         <!-- Left column -->
         <main class="left">
            <div class="card">
               <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                  <strong>Add / Find a Movie</strong>
                  <small class="small">Leave a review!</small>
               </div>
               <!-- UPDATED CONTROLS SECTION -->
               <div class="controls" role="group" aria-label="movie controls">
                  <!-- Full-width Movie Search Bar -->
                  <div class="movie-search-bar">
                     <label for="searchInput" class="search-label">ðŸŽ¬ Movie Search</label>
                     <input type="search" id="searchInput" placeholder="Search movies by title..." />
                  </div>
                  <!-- Second Row for Adding a New Movie -->
                  <div class="movie-add-row">
                     <input type="text" id="newTitle" placeholder="Movie title (required)" />
                     <input type="text" id="newYear" placeholder="Year (optional)" />
                     <input type="text" id="newPoster" placeholder="Poster URL (optional)" />
                     <button id="addMovieBtn">Add / Select</button>
                  </div>
               </div>
               <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                  <div class="small">Sort:</div>
                  <select id="sortSelect">
                     <option value="avg">Highest rated</option>
                     <option value="recent">Most recent</option>
                     <option value="count">Most rated</option>
                     <option value="title">Title Aâ€“Z</option>
                  </select>
                  <div style="flex:1"></div>
                  <div class="small">Show verified-only</div>
                  <input type="checkbox" id="verifiedOnly" />
               </div>
               <div class="movie-list" id="movieList" aria-live="polite"></div>
            </div>
            <div style="height:12px"></div>
            <!-- Old
               <div class="card" id="selectedCard" aria-hidden="true" style="display:none">
                 <strong id="selectedTitle">Selected</strong>
                 <div class="small" id="selectedSubtitle">Movie info</div>
                 <div style="height:12px"></div>
               
                 <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                   <div class="small">Signed in as:</div>
                   <div id="signedInAs" class="pill" style="padding:6px 10px;background:rgba(255,255,255,0.03);border-radius:999px"></div>
                 </div>
               
                 <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
                   <div class="small">Your rating:</div>
                   <div id="ratingStars" class="stars" role="radiogroup" aria-label="Rating stars"></div>
                   <div style="flex:1"></div>
                   <button id="submitRatingBtn">Submit</button>
                 </div>
               
                 <textarea id="comment" placeholder="Optional comment (public)"></textarea>
               
                 <div style="height:12px"></div>
               
                 <div style="display:flex;gap:12px;align-items:center">
                   <div><div class="avg" id="avgScore">â€”</div> <div class="small">avg</div></div>
                   <div class="small" id="ratingCount">â€” ratings</div>
                   <div style="flex:1"></div>
                   <button id="deleteMovie" class="ghost">Delete movie (admin)</button>
                 </div>
               
                 <div style="height:12px"></div>
                 <div id="breakdown" class="small"></div>
               </div>
               -->
         </main>
         <!-- Right column -->
         <aside class="right">
            <div class="card">
               <strong>Top Raters</strong>
               <div class="small">Most contributions</div>
               <div style="height:12px"></div>
               <div class="top-raters" id="topRaters"></div>
               <div style="height:12px"></div>
               <div class="small">How to write a review:</div>
               <pre class="small" style="white-space:pre-wrap">â€¢ Select the movie you want to review.
â€¢ Click the "Leave a Rating" button.
â€¢ Choose your rating from 1 to 10 stars.
â€¢ Optionally, include a comment to share your thoughts.
â€¢ Click "Submit Rating" to finalize your review.</pre>
            </div>
            <div style="height:12px"></div>
            <div class="card">
               <strong>Additional Information</strong>
               <div style="height:8px"></div>
               <ul class="small" style="margin:0;padding-left:18px">
                  <div class="small">How verification works:</div>
                  <pre class="small" style="white-space:pre-wrap">â€¢ Sign in with Google.
â€¢ Create high quality reviews.
â€¢ Admins will periodically add new verified users.
â€¢ Users listed there show a âœ” verified badge when signed in.</pre>
                  <a href='https://www.free-counters.org/'>www.free-Counter.org</a> <script type='text/javascript' src='https://www.freevisitorcounters.com/auth.php?id=784532d4e6654eba9bd92261f6bb3a72460355f1'></script>
                  <script type="text/javascript" src="https://www.freevisitorcounters.com/en/home/counter/1423817/t/0"></script>
               </ul>
            </div>
         </aside>
         <footer>
            Â© 2025 Movie Ratings â€¢ All Rights Reserved
         </footer>
      </div>
      <script type="module">
         /* ============================
            MovieRatings â€” Updated: inline expandable panels + explicit "Leave a rating" button
            Replace the previous <script type="module"> block entirely with this block.
            ============================ */
         
         import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
         import { getDatabase, ref, push, set, onValue, child, get, remove, query, orderByChild, limitToLast, update } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
         import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
         
         /* -------------------------
            YOUR FIREBASE CONFIG
            ------------------------- */
         const firebaseConfig = {
           apiKey: "AIzaSyDPcQhADbFJzw54YLCMPKreZKKLmL1SRW8",
           authDomain: "the-movie-ratings.firebaseapp.com",
           databaseURL: "https://the-movie-ratings-default-rtdb.firebaseio.com",
           projectId: "the-movie-ratings",
           storageBucket: "the-movie-ratings.firebasestorage.app",
           messagingSenderId: "208532935279",
           appId: "1:208532935279:web:875fc444e712c75667b39a",
           measurementId: "G-6582T4SZKR"
         };
         
         const app = initializeApp(firebaseConfig);
         const db = getDatabase(app);
         const auth = getAuth(app);
         const provider = new GoogleAuthProvider();
         
         /* Utilities */
         const uid = () => Math.random().toString(36).slice(2,9);
         const nowISO = () => new Date().toISOString();
         const slugify = s => s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
         const escapeHtml = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
         
         /* DOM refs (unchanged top-level ones) */
         const refs = {
           signInBtn: document.getElementById('signInBtn'),
           signOutBtn: document.getElementById('signOutBtn'),
           signedInControls: document.getElementById('signedInControls'),
           signedOutControls: document.getElementById('signedOutControls'),
           userName: document.getElementById('userName'),
           verifiedBadge: document.getElementById('verifiedBadge'),
           addTitle: document.getElementById('newTitle'),
           addYear: document.getElementById('newYear'),
           addBtn: document.getElementById('addMovieBtn'),
           search: document.getElementById('searchInput'),
           sort: document.getElementById('sortSelect'),
           verifiedOnly: document.getElementById('verifiedOnly'),
           movieList: document.getElementById('movieList'),
           // removed fixed selectedCard references â€” we'll use dynamic panels inserted under rows
           avgScore: document.getElementById('avgScore'), // (these are no longer required, left if you want them elsewhere)
           ratingCount: document.getElementById('ratingCount'),
           breakdown: document.getElementById('breakdown'),
           deleteMovieBtn: document.getElementById('deleteMovie'),
           topRaters: document.getElementById('topRaters'),
           signedInAs: document.getElementById('signedInAs'),
         };
         
         /* App state */
         let currentUser = null;
         let currentVerified = {};
         let ratingsListeners = {}; // movieId -> listener
         let expandedFor = null;    // movieId currently expanded
         let expandedEl = null;     // DOM element for the expanded card
         let pendingRating = 5;
         
         /* Auth (unchanged) */
         refs.signInBtn.addEventListener('click', async () => {
           try { await signInWithPopup(auth, provider); } catch (e) { console.error(e); alert('Sign-in failed: ' + e.message); }
         });
         refs.signOutBtn.addEventListener('click', async ()=> { await signOut(auth); });
         
         onAuthStateChanged(auth, user => {
           currentUser = user;
           if (user) {
             refs.signedOutControls.style.display = 'none';
             refs.signedInControls.style.display = 'flex';
             refs.userName.textContent = user.displayName || user.email || user.uid;
             refs.signedInAs.textContent = (user.displayName || user.email || user.uid);
             checkVerified(user).then(v => renderVerifiedBadge(v));
           } else {
             refs.signedOutControls.style.display = 'flex';
             refs.signedInControls.style.display = 'none';
             refs.userName.textContent = 'â€”';
             refs.signedInAs.textContent = '';
             renderVerifiedBadge(false);
           }
         });
         
         /* Verified watchers (unchanged) */
         function watchVerifiedList() {
           const vRef = ref(db, 'verifiedUsers');
           onValue(vRef, snapshot => {
             currentVerified = snapshot.val() || {};
             if (currentUser) checkVerified(currentUser).then(v => renderVerifiedBadge(v));
           });
         }
         watchVerifiedList();
         
         async function checkVerified(user) {
           if (!user) return false;
           const uidKey = user.uid;
           const safeEmailKey = (user.email || '').replace('.', '_dot_');
           if (currentVerified[uidKey]) return true;
           if (currentVerified[safeEmailKey]) return true;
           if (currentVerified[user.email]) return true;
           return false;
         }
         function renderVerifiedBadge(isVerified) {
           refs.verifiedBadge.innerHTML = isVerified ? '<div class="badge">âœ” Verified</div>' : '';
         }
         
         /* DB helpers */
         function movieRef(movieId){ return ref(db, `movies/${movieId}`); }
         function moviesRoot(){ return ref(db, 'movies'); }
         function ratingsRoot(movieId){ return ref(db, `ratings/${movieId}`); }
         function raterIndexRef(uid){ return ref(db, `raterIndex/${uid}`); }
         
         /* Listen movies (unchanged overall) */
         function listenMovies() {
           const mRef = moviesRoot();
           onValue(mRef, snapshot => {
             const val = snapshot.val() || {};
             renderMovieList(Object.values(val));
           });
         }
         listenMovies();
         
         /* Attach ratings listener for a movie â€” keeps expanded UI live */
         function attachRatingsListener(movieId) {
           if (ratingsListeners[movieId]) return; // already listening
           const rRef = ratingsRoot(movieId);
           const unsub = onValue(rRef, snapshot => {
             // If expanded for this movie, update the panel's stats & rating list
             if (expandedFor === movieId) updateExpandedPanel(movieId, snapshot.val());
             // update top raters
             updateTopRaters();
           });
           // save a marker (firebase onValue returns an unsubscribe function in modular SDK? to keep simple, store truthy)
           ratingsListeners[movieId] = true;
         }
         
         /* Add movie â€” only verified users can add new movies */
         refs.addBtn.addEventListener('click', async () => {
         const title = refs.addTitle.value.trim();
         const year = refs.addYear.value.trim();
         if (!title) return alert('Please enter a movie title.');
         
         // Require login
         if (!currentUser) {
         return alert('You must be signed in to add a movie.');
         }
         
         // Check verification
         const verified = await checkVerified(currentUser);
         if (!verified) {
         return alert('Only verified users can add new movies to the database.');
         }
         
         const slug = slugify(title + (year ? '-' + year : ''));
         const id = slug;
         const mRef = movieRef(id);
         const snapshot = await get(mRef);
         
         if (!snapshot.exists()) {
         const poster = document.getElementById('newPoster').value.trim();
         await set(mRef, {
         id,
         title,
         year,
         slug,
         poster,
         createdAt: nowISO(),
         addedBy: currentUser.uid,
         verifiedAdder: true
         });
         }
         
         attachRatingsListener(id);
         refs.addTitle.value = '';
         refs.addYear.value = '';
         });
         
         /* Delete movie (unchanged except if expanded it closes) */
         refs.deleteMovieBtn && refs.deleteMovieBtn.addEventListener('click', async () => {
           if (!expandedFor) return alert('Select a movie first.');
           if (!currentUser) return alert('Sign in as an admin to delete movies.');
           const verified = await checkVerified(currentUser);
           if (!verified) return alert('Only verified admins may delete movies.');
           if (!confirm('Delete movie and all its ratings? This cannot be undone.')) return;
           await remove(movieRef(expandedFor));
           await remove(ratingsRoot(expandedFor));
           closeExpandedPanel();
         });
         
         /* Render movie list â€” now store data-movie-id and create rows that can expand */
         async function renderMovieList(movieArr) {
           const q = refs.search.value.trim().toLowerCase();
           const onlyVerified = refs.verifiedOnly.checked;
           let arr = (movieArr||[]).slice();
           if (q) arr = arr.filter(m => (m.title + ' ' + (m.year||'')).toLowerCase().includes(q));
         
           // compute stats in parallel (same approach)
           const withStats = await Promise.all(arr.map(async m => {
             const ratingsSnap = await get(ratingsRoot(m.id));
             const ratings = ratingsSnap.val() || {};
             const vals = Object.values(ratings).map(r=>r.score || 0);
             const count = vals.length;
             const avg = count ? Math.round((vals.reduce((a,b)=>a+b,0)/count)*100)/100 : 0;
             const breakdown = {};
             for (let i=1;i<=10;i++) breakdown[i] = 0;
             Object.values(ratings).forEach(r => { breakdown[r.score] = (breakdown[r.score]||0)+1; });
             const hasVerified = Object.values(ratings).some(r => r.verified);
             return {...m, stats:{avg,count,breakdown,hasVerified}};
           }));
         
           // filter & sort
           let final = withStats;
           if (onlyVerified) final = final.filter(m => m.stats.hasVerified);
           const sort = refs.sort.value;
           final.sort((a,b) => {
             if (sort === 'recent') return new Date(b.createdAt) - new Date(a.createdAt);
             if (sort === 'avg') return (b.stats.avg||0) - (a.stats.avg||0);
             if (sort === 'count') return (b.stats.count||0) - (a.stats.count||0);
             if (sort === 'title') return a.title.localeCompare(b.title);
             return 0;
           });
         
           refs.movieList.innerHTML = '';
           if (final.length === 0) {
             refs.movieList.innerHTML = '<div class="small" style="padding:12px">No movies yet. Add one above.</div>';
             return;
           }
         
           for (const m of final) {
             // Movie row
             const row = document.createElement('div');
             row.className = 'movie-row card';
             row.setAttribute('data-movie-id', m.id);
             const posterHtml = m.poster 
         ? `<img src="${escapeHtml(m.poster)}" alt="Poster for ${escapeHtml(m.title)}" class="poster-img" />`
         : `<div class="poster" aria-hidden="true">${escapeHtml(m.title.split(' ').map(s=>s[0]).slice(0,2).join(''))}</div>`;
         
         row.innerHTML = `
         ${posterHtml}
               <div class="meta">
                 <div class="title-row">
                   <div style="min-width:0">
                     <div class="movie-title">${escapeHtml(m.title)} ${m.year?'<span class="small">('+escapeHtml(m.year)+')</span>':''}</div>
                     <div class="small">Added ${new Date(m.createdAt).toLocaleString()}</div>
                   </div>
                   <div style="text-align:right">
                     <div class="avg">${m.stats.count ? m.stats.avg : 'â€”'}</div>
                     <div class="small">${m.stats.count} ratings</div>
                   </div>
                 </div>
               </div>
             `;
             // clicking toggles expand under this row
             row.addEventListener('click', (e) => {
               // If clicked inside the expanded panel's controls (we'll prevent bubbling if needed), ignore.
               const id = m.id;
               // If clicking the row that is already expanded, collapse it
               if (expandedFor === id) { closeExpandedPanel(); return; }
               // else open expand under this row
               openExpandedUnderRow(row, m);
             });
         
             refs.movieList.appendChild(row);
         
             // If this movie is the one expanded, re-insert the expanded element after this row so DOM order stays correct
             if (expandedFor === m.id && expandedEl) {
               refs.movieList.appendChild(expandedEl);
             }
           }
         }
         
         /* Create expanded panel DOM for a movie (returns element) */
         function createExpandedDOM(movie) {
           const container = document.createElement('div');
           container.className = 'card expanded-panel';
           container.setAttribute('data-expanded-for', movie.id);
         
           // Basic structure:
           container.innerHTML = `
             <div style="display:flex;justify-content:space-between;align-items:center;">
               <div>
                 <strong class="expanded-title">${escapeHtml(movie.title)} ${movie.year ? ' ('+escapeHtml(movie.year)+')' : ''}</strong>
                 <div class="small expanded-subtitle">Added ${new Date(movie.createdAt).toLocaleString()}</div>
               </div>
               <div style="text-align:right">
                 <div class="small">Signed in as:</div>
                 <div class="small expanded-signed-in">${escapeHtml(currentUser?.displayName || currentUser?.email || 'â€”')}</div>
               </div>
             </div>
         
             <div style="height:12px"></div>
         
             <div class="expanded-stats small">
         <div class="summary">
         <div>
         <div class="avg expanded-avg">â€”</div>
         <div class="small">avg</div>
         </div>
         <div class="small expanded-count">â€” ratings</div>
         <div style="flex:1"></div>
         <button class="ghost expanded-leave-btn">Leave a Rating</button>
         </div>
         <div class="expanded-breakdown"></div>
         </div>
         
             <div style="height:12px"></div>
         
             <!-- Hidden rating form that appears only when user clicks "Leave a rating" -->
             <div class="expanded-form" style="display:none">
               <div style="display:flex;gap:8px;align-items:center">
                 <div class="small">Your rating:</div>
                 <div class="stars-container" role="radiogroup" aria-label="Rating stars"></div>
                 <div style="flex:1"></div>
                 <button class="ghost expanded-cancel-btn">Cancel</button>
                 <button class="expanded-submit-btn">Submit Rating</button>
               </div>
               <textarea class="expanded-comment" placeholder="Optional comment (public)"></textarea>
             </div>
         
             <div style="height:12px"></div>
         
             <div class="expanded-list small" style="max-height:260px;overflow:auto;border-top:1px dashed rgba(255,255,255,0.03);padding-top:8px"></div>
           `;
         
           // Wire up leave button
           container.querySelector('.expanded-leave-btn').addEventListener('click', (e) => {
             e.stopPropagation();
             // If not signed in -> prompt
             if (!currentUser) return alert('Please sign in to leave a rating.');
             // Show form
             container.querySelector('.expanded-form').style.display = 'flex';
             container.querySelector('.expanded-leave-btn').style.display = 'none';
             const starsContainer = container.querySelector('.stars-container');
             // set pendingRating to previous user rating if exists later when we fetch ratings; for now default 5
             pendingRating = 5;
             renderStars(starsContainer, v => pendingRating = v, pendingRating);
           });
         
           // Cancel rating
           container.querySelector('.expanded-cancel-btn').addEventListener('click', (ev) => {
             ev.stopPropagation();
             container.querySelector('.expanded-form').style.display = 'none';
             container.querySelector('.expanded-leave-btn').style.display = '';
           });
         
           // Submit rating (uses dynamic elements)
           container.querySelector('.expanded-submit-btn').addEventListener('click', async (ev) => {
             ev.stopPropagation();
             const movieId = container.getAttribute('data-expanded-for');
             if (!currentUser) return alert('Please sign in first.');
             if (!movieId) return alert('No movie selected.');
             if (!pendingRating || pendingRating < 1 || pendingRating > 10) return alert('Select a rating between 1â€“10.');
             const comment = container.querySelector('.expanded-comment').value.trim();
             const ratingsRef = ratingsRoot(movieId);
         
             const snapshot = await get(ratingsRef);
             const ratings = snapshot.val() || {};
             const existingKey = Object.keys(ratings).find(k => ratings[k].uid === currentUser.uid);
         
             const verified = await checkVerified(currentUser);
             const ratingData = {
               uid: currentUser.uid,
               displayName: currentUser.displayName || currentUser.email || currentUser.uid,
               email: currentUser.email || '',
               score: pendingRating,
               comment,
               createdAt: nowISO(),
               verified
             };
         
             if (existingKey) {
               await update(child(ratingsRef, existingKey), ratingData);
               alert('Your previous rating has been updated!');
             } else {
               const ratingId = uid();
               await set(child(ratingsRef, ratingId), ratingData);
               const rIndexRef = raterIndexRef(currentUser.uid);
               const rIndexSnap = await get(rIndexRef);
               const oldCount = (rIndexSnap.val() && rIndexSnap.val().count) || 0;
               await set(rIndexRef, {
                 displayName: currentUser.displayName || currentUser.email || currentUser.uid,
                 email: currentUser.email || '',
                 count: oldCount + 1
               });
               alert('Your rating has been submitted!');
             }
         
             // hide form after submit
             container.querySelector('.expanded-form').style.display = 'none';
             container.querySelector('.expanded-leave-btn').style.display = '';
             container.querySelector('.expanded-comment').value = '';
           });
         
           return container;
         }
         
         /* open expanded panel under a specific movie row */
         async function openExpandedUnderRow(rowEl, movie) {
           // close previous if any
           closeExpandedPanel();
         
           // create DOM
           const panel = createExpandedDOM(movie);
           // insert after rowEl
           if (rowEl.nextSibling) rowEl.parentNode.insertBefore(panel, rowEl.nextSibling);
           else rowEl.parentNode.appendChild(panel);
         
           expandedFor = movie.id;
           expandedEl = panel;
         
           // attach ratings listener for live updates & populate
           attachRatingsListener(movie.id);
           const snap = await get(ratingsRoot(movie.id));
           updateExpandedPanel(movie.id, snap.val());
         }
         
         /* update the expanded panel UI given ratings data */
         function updateExpandedPanel(movieId, ratingsVal) {
           if (!expandedEl || expandedFor !== movieId) return;
           const container = expandedEl;
           const ratings = ratingsVal || {};
           const values = Object.values(ratings).map(r => r.score || 0);
           const count = values.length;
           const avg = count ? Math.round((values.reduce((a,b)=>a+b,0)/count)*100)/100 : 0;
         
           container.querySelector('.expanded-avg').textContent = count ? avg : 'â€”';
           container.querySelector('.expanded-count').textContent = (count) + ' ratings';
         
           // breakdown badges
           let html = '<div style="display:flex;gap:8px;flex-wrap:wrap">';
           const breakdown = {};
           for (let i=1;i<=10;i++) breakdown[i] = 0;
           Object.values(ratings).forEach(r => breakdown[r.score] = (breakdown[r.score]||0)+1);
           for (let i=10;i>=1;i--) {
             const pct = count ? Math.round((breakdown[i]/count)*100) : 0;
             html += `<div class="badge" style="opacity:0.95">${i} â€¢ ${pct}%</div>`;
           }
           html += '</div>';
           container.querySelector('.expanded-breakdown').innerHTML = html;
         
           // render ratings list (comments + names + score)
           const listEl = container.querySelector('.expanded-list');
           if (!listEl) return;
           listEl.innerHTML = '';
           const entries = Object.values(ratings).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
           if (entries.length === 0) {
             listEl.innerHTML = '<div class="small">No ratings yet.</div>';
           } else {
             entries.forEach(r => {
         const e = document.createElement('div');
         e.className = 'rating-item';
         e.innerHTML = `
         <div class="avatar">${escapeHtml((r.displayName||r.email||r.uid).slice(0,2).toUpperCase())}</div>
         <div style="flex:1">
         <div style="font-weight:700">${escapeHtml(r.displayName || r.email || r.uid)} <span class="small">â€¢ ${new Date(r.createdAt).toLocaleString()}</span></div>
         <div class="small">Score: ${r.score}/10 ${r.verified ? '<span class="badge">âœ”</span>' : ''}</div>
         ${r.comment ? `<div style="margin-top:6px">${escapeHtml(r.comment)}</div>` : ''}
         </div>
         `;
         listEl.appendChild(e);
         });
           }
         
           // If the current user has an existing rating, adjust the "Leave a rating" button behavior to open form and prefill
           if (currentUser) {
             const existing = Object.values(ratings).find(rr => rr.uid === currentUser.uid);
             if (existing) {
               // Pre-fill when they click leave: set pendingRating to existing.score and comment to existing.comment.
               // We'll store these values in dataset for retrieval when "Leave a rating" is clicked.
               container.querySelector('.expanded-leave-btn').dataset.prefillScore = existing.score;
               container.querySelector('.expanded-leave-btn').dataset.prefillComment = existing.comment || '';
             } else {
               container.querySelector('.expanded-leave-btn').dataset.prefillScore = '';
               container.querySelector('.expanded-leave-btn').dataset.prefillComment = '';
             }
           }
         }
         
         /* close the expanded panel */
         function closeExpandedPanel() {
           if (!expandedEl) return;
           expandedEl.remove();
           expandedEl = null;
           expandedFor = null;
         }
         
         /* stars widget (reused by expanded panels) */
         function renderStars(container, onSelect, value=8) {
           container.innerHTML = '';
           for (let i=1;i<=10;i++){
             const s = document.createElement('div');
             s.className = 'star ' + (i <= value ? 'on' : '');
             s.tabIndex = 0;
             s.setAttribute('role','radio');
             s.setAttribute('aria-checked', i===value ? 'true' : 'false');
             s.title = i + '/10';
             s.textContent = 'â˜…';
             s.addEventListener('click', ()=>{ onSelect(i); renderStars(container,onSelect,i); });
             s.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') { onSelect(i); renderStars(container,onSelect,i); } });
             container.appendChild(s);
           }
         }
         
         /* Top raters (unchanged) */
         function updateTopRaters() {
           const rRef = ref(db, 'raterIndex');
           onValue(rRef, snapshot => {
             const val = snapshot.val() || {};
             const arr = Object.entries(val).map(([uid, data]) => ({ uid, ...data }));
             arr.sort((a,b) => (b.count||0) - (a.count||0));
             refs.topRaters.innerHTML = '';
             if (arr.length === 0) {
               refs.topRaters.innerHTML = '<div class="small">No raters yet.</div>';
               return;
             }
             arr.slice(0,8).forEach(r => {
               const el = document.createElement('div');
               el.className = 'rater';
               el.innerHTML = `<div class="avatar">${escapeHtml((r.displayName||r.email||r.uid).slice(0,2).toUpperCase())}</div>
               <div style="flex:1">
                 <div style="font-weight:700">${escapeHtml(r.displayName || r.email || r.uid)}</div>
                 <div class="small">${r.count || 0} ratings</div>
               </div>
               <div>${currentVerified[r.uid] || currentVerified[(r.email||'').replace('.', '_dot_')] || currentVerified[r.email] ? '<div class="badge">âœ”</div>' : ''}</div>`;
               refs.topRaters.appendChild(el);
             });
           });
         }
         updateTopRaters();
         
         /* Live search/sort handlers: re-fetch and render; keep behavior */
         refs.search.addEventListener('input', async () => { const mSnap = await get(moviesRoot()); renderMovieList(Object.values(mSnap.val()||{})); });
         refs.sort.addEventListener('change', async () => { const mSnap = await get(moviesRoot()); renderMovieList(Object.values(mSnap.val()||{})); });
         refs.verifiedOnly.addEventListener('change', async () => { const mSnap = await get(moviesRoot()); renderMovieList(Object.values(mSnap.val()||{})); });
         
         /* Init: fetch and render */
         (async function init() {
           const mSnap = await get(moviesRoot());
           renderMovieList(Object.values(mSnap.val()||{}));
         })();
         
         /* Allow enter to add movie */
         refs.addTitle.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') refs.addBtn.click(); });
         
      </script>
   </body>
</html>
